---
title: "R Notebook"
output: html_notebook
---


```{r}
library(lme4)
library(ggplot2)
library(plotrix)
library(visreg)
library(stringr)
library(tidyverse)
library(ggpubr)
library(gridExtra)
library(tidyverse)
library(tidymodels)
library(vip) 
library(plm)
```


```{r}
new_format_lasso_data<- read_csv("/Users/noa/Workspace/lasso_positions_sampling_results/new_spr_lasso.csv")
```
```{r}
new_format_lasso_data_edited<-new_format_lasso_data %>% pivot_longer(cols= c("0.01","0.025","0.05","0.1"), values_to="lasso_metrics", names_to = "sample_pct") %>% mutate (test_r2_raw = str_extract(lasso_metrics,'lasso_test_R\\^2.: 0.\\d+'),test_spearman_rho_raw = str_extract(lasso_metrics,'lasso_test_spearmanr.: 0.\\d+'), number_loci_chosen_raw = str_extract(lasso_metrics,'number_loci_chosen.: \\d+')) %>% mutate (sample_pct=  parse_number(sample_pct),test_r2 = parse_number(str_replace(test_r2_raw,"lasso_test_R\\^2.: ","")),test_spearman_rho = parse_number(str_replace(test_spearman_rho_raw,"lasso_test_spearmanr.: ","")),number_loci_chosen = parse_number(str_replace(number_loci_chosen_raw,"number_loci_chosen.: ","")))
```


```{r}
new_format_lasso_data_edited2<- new_format_lasso_data_edited%>%
  mutate(actual_sample_pct =case_when(sample_pct>=0.1 ~ 0.1, sample_pct>=0.05 ~ 0.05,sample_pct>=0.025 ~ 0.025, sample_pct>=0.01 ~ 0.01)) %>%  separate(dataset_id, "_supermatrices_",
                into = c("prefix", "last_value"), 
                remove = FALSE) %>% separate(last_value,"_",into = c("dataset_name", "suffix")) %>%  select(-c("prefix","suffix"))
         


new_format_lasso_data_edited2
new_format_lasso_data_edited2 %>% count(actual_training_size, actual_sample_pct, n_seq, n_loci)
```
```{r}
new_format_lasso_data_edited2 %>% count(dataset_name,actual_training_size, actual_sample_pct, n_seq, n_loci)
```

```{r}
unexplained_variance_data<- new_format_lasso_data_edited2 %>% mutate (unexplained_var =1-test_r2 )

unexplained_variance_data %>% select (n_seq, n_loci,actual_training_size, actual_sample_pct,test_r2, unexplained_var)

unexplained_variance_data %>% group_by(n_seq, n_loci,actual_training_size, actual_sample_pct) %>% summarise(median_unexplained_var = median(unexplained_var))

unexplained_variance_data %>% group_by(actual_training_size, actual_sample_pct, n_loci, n_seq) %>%summarize(median_r_2 = median(unexplained_var),std_r_2 = sd(unexplained_var)) %>%
  ggplot(aes(x=actual_sample_pct,y=median_r_2, group = as.factor(actual_training_size), color = as.factor(actual_training_size))) +geom_line(size=1) + geom_point(size=2) + scale_x_continuous(labels = scales::percent,breaks = c(0.01,0.025,0.05,0.1)) +labs(color="Training size",x="Sample percentage",y="Unexplained variance (%)", title="Median percentage of unexplained variance on test sets") + scale_y_continuous(labels = scales::percent, expand = c(0,0)) +theme_classic()+# coord_cartesian(ylim = c(0, NA))+
  + facet_grid(rows = vars(n_seq), cols = vars(n_loci))

# geom_errorbar(aes(ymin=max(median_r_2-std_r_2,0), ymax=median_r_2+std_r_2),position=position_dodge(0.005)) 

#example_msa_data %>% select (actual_sample_pct, lasso_running_time)
```

