---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 





Dataset first preparation and libraries import
```{r}
library(lme4)
library(ggplot2)
library(plotrix)
library(visreg)
library(stringr)
library(dplyr)

output_data <- data.frame(read.csv("/Users/noa/Workspace/lasso_positions_sampling_results/spr_raxml_10_taxa.csv",header = TRUE, na.strings = ""))
data_source = data.frame(read.csv("/Users/noa/Workspace/data/sampled_datasets.csv",header = TRUE, na.strings = ""))
output_data$relative_path = str_replace_all(output_data$dataset_id,'(/groups/pupko/noaeker/data/ABC_DR/)|(/ref_msa.aa.phy)',"")
data= merge(output_data,data_source,by.x="relative_path",by.y="path")
if (nrow(data)<nrow(output_data))
  {print("Problem in matching path names")}
data=data[data$current_starting_tree_type=="RANDOM"&data$n_seq==10 ,]

#Lasso train and test example
test_df= data.frame(read.csv("/Users/noa/Workspace/lasso_positions_sampling_results/test_sitelh_df_prediction.csv",header = TRUE, na.strings = ""))
names(test_df)[2:3]=c("test_true_val","test_predicted_val")
training_df=data.frame(read.csv("/Users/noa/Workspace/lasso_positions_sampling_results/training_sitelh_df_prediction.csv",header = TRUE, na.strings = ""))
names(training_df)[2:3]=c("training_true_val","training_predicted_val")


#Adding new fields:
data$rho_second_phase = data$naive_SPR_spr_moves/(data$lasso_SPR_second_phase_spr_moves+(data$lasso_SPR_first_phase_spr_moves*data$sample_pct))
data$rho_first_phase = data$naive_SPR_spr_moves/(data$lasso_SPR_first_phase_spr_moves*data$sample_pct)
data$delta_ll_second_phase = data$naive_SPR_ll-data$lasso_SPR_second_phase_ll
data$delta_ll_first_phase = data$naive_SPR_ll-data$lasso_SPR_first_phase_ll

num_cols <- unlist(lapply(data, is.numeric)) 
agg_per_msa = aggregate(data[num_cols], by=list(data$dataset_id), mean,na.action = na.pass)

example_MSA_data = data%>%filter(job_id==24)


```

Usefull functions
```{r}
plot.hist<-function(x,main,xlab, title_size=13, text_size=12)
{
  qplot(x,
      geom="histogram",
      main = main, 
      xlab = xlab,  
      fill=I("blue"), 
      col=I("red"), 
      alpha=I(.2),
      #xlim=c(20,50)
      ) +  theme(plot.title = element_text(hjust = 0.5,size=title_size)) +theme(text = element_text(size = text_size)) 

}

simple.regression<-function(x,y,main,xlab, ylab,cex=1.0,resid_plot=FALSE)
{linearMod <- lm((y) ~ x)
print(main)
print(summary(linearMod)) 
plot(x, y,main=main,
     xlab = xlab, ylab = ylab,pch = 16, col = "blue",cex.main=1,cex=cex)
	abline(linearMod)
if (resid_plot==TRUE)
{plot(fitted(linearMod),resid(linearMod), main =main,xlab=xlab)
abline(0, 0)}
	}


two.groups.hist<-function(vec.a,vec.b,name.a,name.b,title,x.axis.name, title.size=22)
{
 df.a <- data.frame(data = vec.a, name=name.a)
df.b <- data.frame(data = vec.b,name=name.b)
df.ab <- rbind(df.a, df.b)
ggplot(df.ab, aes(data, fill = name)) + geom_density(alpha = 0.2)+
theme(legend.title=element_blank())+labs(title=title)+xlab(x.axis.name)+
theme(plot.title = element_text(hjust = 0.5))+
theme(plot.title = element_text(size=title.size))
}

#two.groups.hist(c(1,1,12,2,2,2,2),c(1,1,12,2,2,2,2),"name.a","name.b","title","x.axis.name")


```


Counting the different sources
```{r}
file_name_and_source=data[!duplicated(data[ , c("db","dataset_id")]),]

table(file_name_and_source$db)
```


Find and remove problematic datasets:
```{r}
high_delta_ll_datasets_first_phase = select(data%>%filter(delta_ll_first_phase==max(data$delta_ll_first_phase)),dataset_id, mistake_cnt, n_loci,delta_ll_first_phase, delta_ll_second_phase,ll_pearson_during_tree_search, divergence, avg_entropy, n_loci,number_loci_chosen, sample_pct,lasso_test_R.2,lasso_training_R.2)

high_delta_ll_datasets_second_phase = select(data%>%filter(delta_ll_second_phase==max(data$delta_ll_second_phase)),dataset_id, mistake_cnt, n_loci, delta_ll_first_phase, delta_ll_second_phase,ll_pearson_during_tree_search)

low_pearson_datasets = select(data%>%filter(ll_pearson_during_tree_search==min(data$ll_pearson_during_tree_search)),dataset_id, n_loci,ll_pearson_during_tree_search,delta_ll_second_phase)
 problematic_rho_values=(select(data%>%filter(rho_first_phase==0 | is.na(rho_first_phase)| !is.finite(rho_first_phase) ),dataset_id,rho_second_phase,lasso_SPR_first_phase_spr_moves, lasso_SPR_second_phase_spr_moves, naive_SPR_spr_moves))

#data= data%>%filter(is.finite(rho_first_phase)&!is.na(rho_first_phase)&rho_first_phase>0)

#print(problematic_rho_values)
print(high_delta_ll_datasets_first_phase)
#print(low_pearson_datasets )
```


An example of the LL approximation
Change the example to another one
```{r}
#Specific example of Lasso: 
#Make sure what is the #positions chosen by lasso here.

print("Data about the chosen MSA")
print(select(example_MSA_data,"dataset_id", "db","number_loci_chosen","n_loci","alpha","lasso_training_R.2", "lasso_test_R.2"))
print(training_df[,c("training_predicted_val","training_true_val")])
print(test_df[,c("test_predicted_val","test_true_val")])


simple.regression(training_df$training_true_val,training_df$training_predicted_val,"Training set predicted log likelihood vs true log likelihood","Training set true log likelihood","Training set predicted log likelihood")
simple.regression(test_df$test_true_val,test_df$test_predicted_val,"Test set predicted log likelihood vs true log likelihood","Test set true log likelihood","Test set predicted log likelihood",cex=1)

```

LL approximation on xxx datasets:
```{r}
print("lasso training R^2:")
print(summary(data$lasso_training_R.2))
print("lasso test R^2:")
print(summary(data$lasso_test_R.2))
print("lasso sample pct :")
print(summary(data$sample_pct))
plot.hist(data$sample_pct,main="Histogram of the percentage of positions chosen by Lasso across MSAs", xlab="percentage of positions chosen by Lasso")
plot.hist(data$number_loci_chosen,main="Histogram of the number of positions chosen by Lasso across MSAs", xlab="number of positions chosen by Lasso")

simple.regression(x=data$divergence, y=data$lasso_test_R.2, main= "Lasso test R^2 vs. divergence", xlab="divergence",ylab="lasso_test_R.2")

simple.regression(x=data$avg_entropy, y=data$lasso_test_R.2, main= "Lasso test R^2 vs. Entropy", xlab="Entropy",ylab="lasso_test_R.2")

simple.regression(x=data$n_loci, y=data$lasso_test_R.2, main= "Lasso test R^2 vs. number of positions", xlab="Number of positions",ylab="lasso_test_R.2")

simple.regression(x=data$number_loci_chosen , y=data$lasso_test_R.2, main= "Lasso test R^2 vs. number of positions chosen by Lasso", xlab="Number of positions chosen bvy lasso",ylab="lasso_test_R.2")

plot.hist(data$delta_ll_first_phase,"Histogram of delta likelihood values across MSAs and starting trees", xlab="delta log likelihood value")

simple.regression(x=data$n_loci,y=1/data$sample_pct,main="Inverse fraction of positions chosen by Lasso vs. function of the number of positions",xlab="Number of positions",ylab="Inverse fraction of positions chosen by lasso",resid=TRUE)






```

Effect on the SPR search on the example MSA:
Many starting trees on one chosen dataset
```{r}

print("Delta ll summary:")
print(summary(example_MSA_data$delta_ll_first_phase))
print("Rho summary:")
print(summary(example_MSA_data$rho_first_phase))
plot.hist(example_MSA_data$delta_ll_first_phase, main="Histogram of delta log likelihood values between naive SPR and its lasso based variant", xlab="Delta log likelihood", title_size=12, text_size=11)
best_tree = max(example_MSA_data$overall_best_topology_first_phase ) # removing duplicates
cat("best tree is :",best_tree,"\n") #lasso got it xxx times, naive got it yyy times
lasso_cnt_best_tree=sum(example_MSA_data$rf_first_phase_vs_overall_best==0)
naive_cnt_best_tree=sum(example_MSA_data$rf_naive_vs_overall_best_first_phase==0)
cat("Lasso got best tree",lasso_cnt_best_tree,"times\n")
cat("Naive got best tree",naive_cnt_best_tree,"times\n")
avg_rf_best_tree_lasso= mean(example_MSA_data$rf_first_phase_vs_overall_best)
avg_rf_best_tree_naive=mean(example_MSA_data$rf_naive_vs_overall_best_first_phase)
cat("The average RF  between best tree and lasso is:",avg_rf_best_tree_lasso,"\n")
cat("The average RF between best tree and naive is:", avg_rf_best_tree_naive,"\n")
average_spr_moves_naive = mean(example_MSA_data$naive_SPR_spr_moves)
average_spr_moves_lasso_first_phase = mean(example_MSA_data$lasso_SPR_first_phase_spr_moves)
cat("Average number of SPR steps in naive SPR is:", average_spr_moves_naive,"\n")
cat("Average number of SPR steps in lasso first phase SPR variant is:", average_spr_moves_lasso_first_phase,"\n" )
plot.hist(example_MSA_data$rho_first_phase,main="Histogram of rho across different starting trees",xlab="rho")
```


Effect on the SPR search on 50 datasets:

```{r}
print("Summary of R squared during tree search:")
print(summary(data$ll_pearson_during_tree_search^2))
print("Summary of delta ll:")
print(summary(data$delta_ll_first_phase))
plot.hist(data$ll_pearson_during_tree_search^2, main = "Histogram of R^2 during tree search", xlab="R^2 during tree search")
two.groups.hist(data$naive_SPR_spr_moves, data$lasso_SPR_first_phase_spr_moves,"Standard SPR spr moves","Lasso-based SPR spr moves","Histogram of standard SPR spr moves and lasso-based SPR spr moves across different MSAs and starting trees","Number of SPR moves")
plot.hist(data$naive_SPR_spr_moves, main = "Histogram of naive SPR spr moves across different MSAs and starting trees", xlab="SPR moves")
plot.hist(data$rho_first_phase,main="Histogram of rho across different MSAs and starting trees",xlab="rho")
plot.hist(data$delta_ll_first_phase ,main="Histogram of delta likelihood values across different MSAs and starting trees",xlab="delta ll")
simple.regression(x=data$ll_pearson_during_tree_search^2,y=data$lasso_test_R.2,main="Lasso test R^2 vs R^2 during tree search",xlab="R^2 during tree search",ylab="Lasso test R^2")


#same on aggregated data:
plot.hist(agg_per_msa$ll_pearson_during_tree_search^2, main = "Histogram of R^2 during tree search (aggregated)", xlab="R^2 during tree #search")
plot.hist(agg_per_msa$naive_SPR_spr_moves, main = "Histogram of SPR naive moves across different MSAs and starting trees (aggregated)", xlab="SPR moves")
plot.hist(agg_per_msa$rho_first_phase,main="Histogram of rho across different MSAs and starting trees (aggregated)",xlab="rho")
plot.hist(agg_per_msa$delta_ll_first_phase ,main="Histogram of delta likelihood values across different MSAs and starting trees (aggregated)",xlab="rho")
simple.regression(x=agg_per_msa$lasso_test_R.2,y=agg_per_msa$ll_pearson_during_tree_search^2,main="Lasso test R^2 vs R^2 during tree search (aggregated)",xlab="Lasso test R^2",ylab="R^2 during tree search")




```

Effect on the SPR search on the example MSA:  MODIFIED SPR SEARCH (including second phase)

```{r}

example_MSA_data = data%>%filter(job_id==24)
plot.hist(example_MSA_data$delta_ll_second_phase , main="Delta log likelihood values between naive SPR and the lasso based variant", xlab="Delta log likelihood", title_size=12, text_size=11)
best_tree = max(example_MSA_data$overall_best_topology_second_phase) # removing duplicates
cat("best tree is :",best_tree,"\n") #lasso got it xxx times, naive got it yyy times
lasso_cnt_best_tree=sum(example_MSA_data$rf_second_phase_vs_overall_best ==0)
naive_cnt_best_tree=sum(example_MSA_data$rf_naive_vs_overall_best_second_phase==0)
cat("Lasso got best tree",lasso_cnt_best_tree,"times\n")
cat("Naive got best tree",naive_cnt_best_tree,"times\n")
avg_rf_best_tree_lasso= mean(example_MSA_data$rf_second_phase_vs_overall_best)
avg_rf_best_tree_naive=mean(example_MSA_data$rf_naive_vs_overall_best_second_phase)
cat("The average RF  between best tree and lasso is:",avg_rf_best_tree_lasso,"\n")
cat("The average RF between best tree and naive is:", avg_rf_best_tree_naive,"\n")
average_spr_moves_naive = mean(example_MSA_data$naive_SPR_spr_moves)
average_spr_moves_lasso_first_phase = mean(example_MSA_data$lasso_SPR_first_phase_spr_moves)
average_spr_moves_lasso_seond_phase = mean(example_MSA_data$lasso_SPR_second_phase_spr_moves)
cat("Average number of SPR steps in naive SPR is:", average_spr_moves_naive,"\n")
cat("Average number of SPR steps in lasso first phase SPR variant is:", average_spr_moves_lasso_first_phase,"\n" )
cat("Average number of SPR steps in lasso second phase SPR variant is:", average_spr_moves_lasso_seond_phase,"\n" )
plot.hist(example_MSA_data$rho_second_phase ,main="Histogram of rho across different starting trees",xlab="rho")



```


Effect on the SPR search on the example MSA on xxx datasets: MODIFIED SPR SEARCH (including second phase)

```{r}
plot.hist(data$lasso_SPR_second_phase_spr_moves , main = "Histogram of Lasso second phase spr moves across different MSAs and starting trees", xlab="SPR moves",title_size = 10)
plot.hist(data$rho_second_phase ,main="Histogram of rho (second phase) across different MSAs and starting trees",xlab="rho (second_phase)",title_size = 10)
plot.hist(data$delta_ll_second_phase ,main="Histogram of delta likelihood (second phase) values across different MSAs and starting trees",xlab="delta ll (second phase)",title_size = 10)


#same on aggregated data:
plot.hist(agg_per_msa$lasso_SPR_second_phase_spr_moves , main = "Histogram of Lasso second phase spr moves across different MSAs and starting trees (aggregated)", xlab="SPR moves",title_size = 10)
plot.hist(agg_per_msa$rho_second_phase ,main="Histogram of rho (aggregated second phase) across different MSAs and starting trees",xlab="rho (second_phase)",title_size = 10)
plot.hist(agg_per_msa$delta_ll_second_phase ,main="Histogram of delta likelihood (aggregated second phase) values across different MSAs and starting trees",xlab="delta ll (second phase)",title_size = 10)




```

Visualizing  fitted regression line of rho~ n_loci per dataset

```{r}
library(visreg)
lm = lm(log(rho_second_phase)~n_loci+naive_SPR_spr_moves+dataset_id , data = data)
visreg(lm, "naive_SPR_spr_moves", by=("dataset_id") ,overlay =TRUE, legend = FALSE)

```

Generating a linear mixed model
```{r}
#centering predictors
plot(example_MSA_data$naive_SPR_spr_moves, example_MSA_data$rho_second_phase)
plot(data$naive_SPR_spr_moves, data$rho_second_phase)
data$n_loci_centered_per_1000 = (data$n_loci-mean(data$n_loci))/1000
data$avg_entropy_centered = data$avg_entropy-mean(data$avg_entropy)
data$naive_SPR_spr_moves_centered = data$naive_SPR_spr_moves  -mean(data$naive_SPR_spr_moves)
#mixed model
rho_lmer = lmer(log(rho_second_phase)~(1|dataset_id)+n_loci_centered_per_1000+naive_SPR_spr_moves_centered+data$avg_entropy_centered,data)
print(summary(rho_lmer))
qqnorm(ranef(rho_lmer)$dataset_id[, "(Intercept)"], main = "Random effects")
abline(a=0,b=1)
plot((rho_lmer))


```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
