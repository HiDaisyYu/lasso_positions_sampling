---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 





Dataset first preparation and libraries import
```{r}
library(lme4)
library(ggplot2)
library(plotrix)
library(visreg)
library(stringr)

data_unified <- data.frame(read.csv("/Users/noa/Workspace/lasso_positions_sampling_results/spr_raxml.csv",header = TRUE, na.strings = ""))
data_source = data.frame(read.csv("/Users/noa/Workspace/data/sampled_datasets.csv",header = TRUE, na.strings = ""))
data_unified$relative_path = str_replace_all(data_unified$dataset_id,'(/groups/pupko/noaeker/data/ABC_DR/)|(/ref_msa.aa.phy)',"")
data= merge(data_unified,data_source,by.x="relative_path",by.y="path")
if (nrow(data)<nrow(data_unified))
  {print("Problem in matching path names")}
data=data[data$current_starting_tree_type=="RANDOM"&data$n_seq==5 ,]
write.csv(data,"data.csv", row.names = FALSE)

num_cols <- unlist(lapply(data, is.numeric)) 
agg_per_msa = aggregate(data[num_cols], by=list(data$dataset_id), mean,na.action = na.pass)


```

Usefull functions
```{r}
plot.hist<-function(x,main,xlab, title_size=13, text_size=12)
{
  qplot(x,
      geom="histogram",
      main = main, 
      xlab = xlab,  
      fill=I("blue"), 
      col=I("red"), 
      alpha=I(.2),
      #xlim=c(20,50)
      ) +  theme(plot.title = element_text(hjust = 0.5,size=title_size)) +theme(text = element_text(size = text_size)) 

}

simple.regression<-function(x,y,main,xlab, ylab,cex=1.0,resid_plot=FALSE)
{linearMod <- lm((y) ~ x)
print(summary(linearMod)) 
plot(x, y,main=main,
     xlab = xlab, ylab = ylab,pch = 16, col = "blue",cex.main=1,cex=cex)
	abline(linearMod)
if (resid_plot==TRUE)
{plot(fitted(linearMod),resid(linearMod), main = "Residual plot",xlab=xlab)
abline(0, 0)}
	}







```

Expanding the dataset with new fields
```{r}
data$rho_second_phase = data$naive_SPR_spr_moves/(data$lasso_SPR_second_phase_spr_moves+(data$lasso_SPR_first_phase_spr_moves*data$sample_pct))
data$rho_first_phase = data$naive_SPR_spr_moves/(data$lasso_SPR_first_phase_spr_moves*data$sample_pct)
data$delta_ll_second_phase = data$naive_SPR_ll-data$lasso_SPR_second_phase_ll
data$delta_ll_first_phase = data$naive_SPR_ll-data$lasso_SPR_first_phase_ll

```


Counting the different sources
```{r}
file_name_and_source=data[!duplicated(data[ , c("db","dataset_id")]),]

table(file_name_and_source$db)
```


Find problematic datasets:
```{r}
library(dplyr)
high_delta_ll_datasets_first_phase = select(data%>%filter(delta_ll_first_phase==max(data$delta_ll_first_phase)),dataset_id, n_loci,delta_ll_first_phase, delta_ll_second_phase,ll_pearson_during_tree_search, divergence, avg_entropy, n_loci,number_loci_chosen, sample_pct,lasso_test_R.2,lasso_training_R.2)
high_delta_ll_datasets_second_phase = select(data%>%filter(delta_ll_second_phase==max(data$delta_ll_second_phase)),dataset_id, n_loci, delta_ll_first_phase, delta_ll_second_phase,ll_pearson_during_tree_search)
low_pearson_datasets = select(data%>%filter(ll_pearson_during_tree_search==min(data$ll_pearson_during_tree_search)),dataset_id, n_loci,ll_pearson_during_tree_search,delta_ll_second_phase)
print(select(data%>%filter(rho_second_phase==0),lasso_SPR_first_phase_spr_moves, lasso_SPR_second_phase_spr_moves, naive_SPR_spr_moves))

print(high_delta_ll_datasets_first_phase)
#print(low_pearson_datasets )
```


An example of the LL approximation

```{r}
#Specific example of Lasso: 
#Make sure what is the #positions chosen by lasso here.

test_df= data.frame(read.csv("/Users/noa/Workspace/lasso_positions_sampling_results/test_sitelh_df_prediction.csv",header = TRUE, na.strings = ""))
training_df=data.frame(read.csv("/Users/noa/Workspace/lasso_positions_sampling_results/training_sitelh_df_prediction.csv",header = TRUE, na.strings = ""))

test_true_val<-test_df$X0
test_predicted_val<-test_df$X1

training_true_val<-training_df$X0
training_predicted_val<-training_df$X1

simple.regression(training_true_val,training_predicted_val,"Training set predicted log likelihood vs true log likelihood","Training set true log likelihood","Training set predicted log likelihood")
simple.regression(test_true_val,test_predicted_val,"Test set predicted log likelihood vs true log likelihood","Test set true log likelihood","Test set predicted log likelihood",cex=1)

```

LL approximation on xxx datasets:
```{r}
print("lasso training R^2:")
print(summary(data$lasso_training_R.2))
print("lasso test R^2:")
print(summary(data$lasso_test_R.2))
print("lasso sample pct :")
print(summary(data$sample_pct))
plot.hist(data$sample_pct,main="Histogram of the percentage of positions chosen by Lasso across MSAs", xlab="percentage of positions chosen by Lasso")
plot.hist(data$number_loci_chosen,main="Histogram of the number of positions chosen by Lasso across MSAs", xlab="number of positions chosen by Lasso")

simple.regression(x=data$divergence, y=data$lasso_test_R.2, main= "Lasso test R^2 vs. divergence", xlab="divergence",ylab="lasso_test_R.2")

simple.regression(x=data$avg_entropy, y=data$lasso_test_R.2, main= "Lasso test R^2 vs. Entropy", xlab="Entropy",ylab="lasso_test_R.2")

simple.regression(x=data$n_loci, y=data$lasso_test_R.2, main= "Lasso test R^2 vs. number of positions", xlab="Number of positions",ylab="lasso_test_R.2")

plot.hist(data$delta_ll_first_phase,"Histogram of delta likelihood values across MSAs and starting trees", xlab="delta log likelihood value")

plot((agg_per_msa$n_loci),(agg_per_msa $sample_pct))
ggplot(agg_per_msa, aes(x=(n_loci), y=(sample_pct))) + 
  geom_point()+
  geom_smooth()+
  theme(plot.title = element_text(hjust = 0.5,size=13)) +theme(text = element_text(size = 12))+
  labs(title= "Percentage of positions chosen by lasso vs. number of positions across MSAs",
                      y="Percentage of positions chosen by lasso", x = "Number of positions")



```

Effect on the SPR search on the example MSA:
Many starting trees on one chosen dataset
```{r}

job_0_data = data%>%filter(job_id==24)
plot.hist(job_0_data$delta_ll_first_phase, main="Histogram of delta log likelihood values between naive SPR and its lasso based variant", xlab="Delta log likelihood", title_size=12, text_size=11)
best_tree = max(job_0_data$overall_best_topology_first_phase ) # removing duplicates
cat("best tree is :",best_tree,"\n") #lasso got it xxx times, naive got it yyy times
lasso_cnt_best_tree=sum(job_0_data$rf_first_phase_vs_overall_best==0)
naive_cnt_best_tree=sum(job_0_data$rf_naive_vs_overall_best_first_phase==0)
cat("Lasso got best tree",lasso_cnt_best_tree,"times\n")
cat("Naive got best tree",naive_cnt_best_tree,"times\n")
avg_rf_best_tree_lasso= mean(job_0_data$rf_first_phase_vs_overall_best)
avg_rf_best_tree_naive=mean(job_0_data$rf_naive_vs_overall_best_first_phase)
cat("The average RF  between best tree and lasso is:",avg_rf_best_tree_lasso,"\n")
cat("The average RF between best tree and naive is:", avg_rf_best_tree_naive,"\n")
average_spr_moves_naive = mean(job_0_data$naive_SPR_spr_moves)
average_spr_moves_lasso_first_phase = mean(job_0_data$lasso_SPR_first_phase_spr_moves)
cat("Average number of SPR steps in naive SPR is:", average_spr_moves_naive,"\n")
cat("Average number of SPR steps in lasso first phase SPR variant is:", average_spr_moves_lasso_first_phase,"\n" )
plot.hist(job_0_data$rho_first_phase,main="Histogram of rho across different starting trees",xlab="rho")
```


Effect on the SPR search on the example MSA on xxx datasets:

```{r}
plot.hist(data$ll_pearson_during_tree_search^2, main = "Histogram of R^2 during tree search", xlab="R^2 during tree #search")
plot.hist(data$naive_SPR_spr_moves, main = "Histogram of naive SPR moves across different MSAs and starting trees", xlab="SPR moves")
plot.hist(data$rho_first_phase,main="Histogram of rho across different MSAs and starting trees",xlab="rho")
plot.hist(data$delta_ll_first_phase ,main="Histogram of delta likelihood values across different MSAs and starting trees",xlab="rho")
simple.regression(x=data$ll_pearson_during_tree_search^2,y=data$lasso_test_R.2,main="Lasso test R^2 vs R^2 during tree search",xlab="R^2 during tree search",ylab="Lasso test R^2")


#same on aggregated data:
plot.hist(agg_per_msa$ll_pearson_during_tree_search^2, main = "Histogram of R^2 during tree search (aggregated)", xlab="R^2 during tree #search")
plot.hist(agg_per_msa$naive_SPR_spr_moves, main = "Histogram of SPR naive moves across different MSAs and starting trees (aggregated)", xlab="SPR moves")
plot.hist(agg_per_msa$rho_first_phase,main="Histogram of rho across different MSAs and starting trees (aggregated)",xlab="rho")
plot.hist(agg_per_msa$delta_ll_first_phase ,main="Histogram of delta likelihood values across different MSAs and starting trees (aggregated)",xlab="rho")
simple.regression(x=agg_per_msa$ll_pearson_during_tree_search^2,y=agg_per_msa$lasso_test_R.2,main="Lasso test R^2 vs R^2 during tree search (aggregated)",xlab="R^2 during tree search",ylab="Lasso test R^2")




```




Visualizing  fitted regression line of rho~ n_loci per dataset

```{r}
library
lm = lm(log(pct_spr_moves)~n_loci , data = data)
lm1 = lm(log(pct_spr_moves)~n_loci+dataset_id , data = data)
visreg(lm, "n_loci" ,overlay =TRUE, legend = FALSE)
visreg(lm1, "n_loci", by=("dataset_id") ,overlay =TRUE, legend = FALSE)

```

Generating a linear mixed model
```{r}
#centering predictors
plot(data$n_loci, data$rho_second_phase)
data$n_loci_centered = data$n_loci-mean(data$n_loci)
data$naive_SPR_spr_moves_centered = data$naive_SPR_spr_moves  -mean(data$naive_SPR_spr_moves)
data$divergence_centered = data$divergence-mean(data$divergence)
#mixed model
print(select(data%>%filter(rho_second_phase==0),lasso_SPR_first_phase_spr_moves, lasso_SPR_second_phase_spr_moves, naive_SPR_spr_moves))
#pct_spr_moves_lmer = lmer(log(rho_second_phase)~(1|dataset_id)+n_loci_centered+divergence_centered,data)
#print(summary(pct_spr_moves_lmer))
#qqnorm(ranef(pct_spr_moves_lmer)$dataset_id[, "(Intercept)"], main = "Random effects")
#plot((pct_spr_moves_lmer))


```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
