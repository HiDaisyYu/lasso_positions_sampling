---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
options(digits=10)
spr_data<-read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f_g30.tsv")
```

15,30 and 60 taxa analysis

```{r}
spr_data_edited<- spr_data  %>%
  mutate( 
          ) %>%
            separate(dataset_id, "_supermatrices_",
                into = c("prefix", "last_value"), 
                remove = FALSE) %>% separate(last_value,"_",into = c("dataset_name", "suffix")) %>%  select(-c("prefix","suffix")) %>% select (dataset_name, actual_n_seq, actual_n_loci, `lasso_test_R^2_phase_0`,naive_SPR_SPR_ll,final_phase_SPR_ll, phase_0_SPR_ll,rf_best_naive_vs_best_lasso,                                                                                                               naive_SPR_spr_moves,                                                                                                                  naive_SPR_no_brlen_running_time,
                                                                                                                                               naive_SPR_total_spr_neighbours_evaluated,                                                                                                                    naive_SPR_brlen_running_time,                                                                                                 naive_SPR_total_spr_neighbours_optimized,                                                                                                               naive_SPR_running_time
                                                                                                                                               ,
  phase_0_spr_moves,
  phase_0_re_opt_running_time,
  phase_0_no_brlen_running_time,
  phase_0_total_spr_neighbours_optimized,
  phase_0_total_spr_neighbours_evaluated, phase_0_total_spr_neighbours_reoptimized,
  phase_0_brlen_running_time,
  phase_0_running_time,
  final_phase_spr_moves,
  final_phase_no_brlen_running_time,
  final_phase_total_spr_neighbours_evaluated,
  final_phase_brlen_running_time,
  final_phase_total_spr_neighbours_optimized,
  final_phase_running_time,
  full_training_random_trees_generation_time_phase_0,
  lasso_running_time_phase_0,
   full_size_training_evaluation_time_phase_0
  ) %>% mutate(delta_ll_final = ifelse(rf_best_naive_vs_best_lasso>0,naive_SPR_SPR_ll-final_phase_SPR_ll,0))

spr_data_edited
```
Example MSA:
```{r}
n_cores_full =15
n_cores_lasso = 1
example_msa_data<-spr_data_edited %>% filter (dataset_name=="NagyA1",actual_n_seq==30)
example_msa_data %>% select (delta_ll_final,naive_SPR_running_time, phase_0_running_time, final_phase_running_time)
example_msa_lasso_iterations<- read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f_g30_nagy_lasso_iterations.tsv") %>% mutate(iter= row_number()) 
example_msa_naive_iterations<- read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f_g30_nagy_full_iterations.tsv") %>% mutate(iter= row_number()) 
example_msa_lasso_iterations
example_msa_lasso_iterations %>% select (phase_name, ll, true_ll)

best_ll = max(c(example_msa_naive_iterations %>% pull (true_ll),example_msa_lasso_iterations %>% pull (true_ll)))
start_ll = example_msa_naive_iterations %>% pull(true_ll)

example_msa_iterations<-rbind(example_msa_lasso_iterations,example_msa_naive_iterations)

example_msa_iterations %>% ggplot(aes(x= iter-1,y= ll,colour = phase_name)) + geom_point(size=0.5)+ geom_line()+labs(x="Iteration number" ,y = "local log-likelihood")+theme_classic()+guides(col=guide_legend("Search type"))+theme(strip.text.y = element_text(angle = 0))

example_msa_iterations %>% ggplot(aes(x= iter-1,y= best_ll-true_ll,colour = phase_name)) + geom_point(size=0.5)+ geom_line()+labs(x="Iteration number" ,y = "Delta log-likelihood")+theme_classic()+guides(col=guide_legend("Search type"))+theme(strip.text.y = element_text(angle = 0))


 # running_time_analysis
example_msa_data %>% select (naive_SPR_no_brlen_running_time,naive_SPR_brlen_running_time, phase_0_no_brlen_running_time, phase_0_brlen_running_time,final_phase_no_brlen_running_time, final_phase_brlen_running_time, full_size_training_evaluation_time_phase_0, lasso_running_time_phase_0) %>% mutate (run_time_naive = n_cores_full*(naive_SPR_no_brlen_running_time+naive_SPR_brlen_running_time), run_time_lasso = n_cores_lasso*(phase_0_no_brlen_running_time+phase_0_brlen_running_time) + n_cores_lasso*final_phase_no_brlen_running_time+n_cores_full*final_phase_brlen_running_time, run_time_training = full_size_training_evaluation_time_phase_0* n_cores_full, run_time_lasso_algorithm =lasso_running_time_phase_0  ) %>% mutate(ratio_including_training =run_time_naive/(run_time_lasso+run_time_training+run_time_lasso_algorithm
) , ratio_without_training =run_time_naive/run_time_lasso)



# Operations and SPR moves analysis
example_msa_data %>% select (phase_0_spr_moves,naive_SPR_spr_moves,final_phase_spr_moves,naive_SPR_total_spr_neighbours_evaluated,naive_SPR_total_spr_neighbours_optimized, phase_0_total_spr_neighbours_evaluated, phase_0_total_spr_neighbours_optimized,final_phase_total_spr_neighbours_evaluated, final_phase_total_spr_neighbours_optimized, full_size_training_evaluation_time_phase_0) %>% mutate (naive_full_brlen_opt = naive_SPR_total_spr_neighbours_optimized,naive_full_eval =naive_SPR_total_spr_neighbours_evaluated, lasso_sampled_eval =phase_0_total_spr_neighbours_evaluated+final_phase_total_spr_neighbours_evaluated, lasso_sampled_optimized = phase_0_total_spr_neighbours_optimized, lasso_full_optimized = final_phase_total_spr_neighbours_optimized )


```
Run time analysis

```{r}
n_cores_full =15
n_cores_lasso = 1

 # running_time_analysis
all_msa_running_time<-spr_data_edited %>% select (dataset_name,`lasso_test_R^2_phase_0`,delta_ll_final,actual_n_seq,naive_SPR_no_brlen_running_time,naive_SPR_brlen_running_time, phase_0_no_brlen_running_time, phase_0_brlen_running_time,final_phase_no_brlen_running_time, final_phase_brlen_running_time, full_size_training_evaluation_time_phase_0, lasso_running_time_phase_0) %>% mutate (run_time_naive = n_cores_full*(naive_SPR_no_brlen_running_time+naive_SPR_brlen_running_time), run_time_lasso = n_cores_lasso*(phase_0_no_brlen_running_time+phase_0_brlen_running_time) + n_cores_lasso*final_phase_no_brlen_running_time+n_cores_full*final_phase_brlen_running_time, run_time_training = full_size_training_evaluation_time_phase_0* n_cores_full, run_time_lasso_algorithm =lasso_running_time_phase_0  ) %>% mutate(ratio_including_training =run_time_naive/(run_time_lasso+run_time_training+run_time_lasso_algorithm
) , ratio_without_training =run_time_naive/run_time_lasso) 

all_msa_running_time %>% group_by(actual_n_seq) %>% summarise(median_ratio_including_training = median (ratio_including_training),median_ratio_without_training = median ( ratio_without_training))

all_msa_running_time 


lasso_training<-spr_data_edited %>% select (actual_n_seq, dataset_name,time =full_training_random_trees_generation_time_phase_0) %>% mutate(operation = "evaluation using full data (training data generation)", time = time *n_cores_full,search_type = "Lasso-based search", phase = "training")

lasso_cd<-spr_data_edited %>% select (actual_n_seq, dataset_name,time =lasso_running_time_phase_0) %>% mutate(operation = "Lasso-algorithm time", time = time ,search_type = "Lasso-based search", phase = "training") 

lasso_first_phase_no_brlen<-spr_data_edited %>% select (actual_n_seq, dataset_name,time =phase_0_no_brlen_running_time) %>% mutate(operation = "evaluation using 5% of data", time = time *n_cores_lasso,search_type = "Lasso-based search", phase = "first_phase") 
lasso_first_phase_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =phase_0_brlen_running_time) %>% mutate(operation = "branch-lengths optimization using 5% of data", time = time*n_cores_lasso ,search_type = "Lasso-based search",phase = "first_phase")  

lasso_final_phase_no_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =final_phase_no_brlen_running_time) %>% mutate(operation = "evaluation using 5% of data",time=time *n_cores_lasso ,search_type = "Lasso-based search",phase = "final_phase") 
lasso_final_phase_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =final_phase_brlen_running_time) %>% mutate(operation = "branch-lengths optimization using full data",time= time *n_cores_full ,search_type = "Lasso-based search",phase = "final_phase") 

naive_no_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =naive_SPR_no_brlen_running_time) %>% mutate(operation = "evaluation using full data",time= time *n_cores_full , search_type = "Standard search",phase = "Naive")
naive_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =naive_SPR_brlen_running_time) %>% mutate(operation = "branch-lengths optimization using full data",time= time *n_cores_full , search_type = "Standard search",phase = "Naive") 

running_time_data<-rbind(lasso_first_phase_no_brlen,lasso_first_phase_brlen,lasso_final_phase_no_brlen,lasso_final_phase_brlen,naive_no_brlen,naive_brlen,lasso_training,lasso_cd)
overall_running_time_data<-running_time_data %>% group_by(dataset_name, actual_n_seq,operation,search_type) %>% summarise(time = sum(time))

running_time_data %>% arrange(dataset_name, actual_n_seq,operation,search_type)


overall_running_time_data  %>% ggplot(aes(x=search_type, y=time, fill=operation)) +
  geom_bar(stat="identity")+
  scale_fill_manual("legend", values = c("branch-lengths optimization using full data"= "#3e7db8","branch-lengths optimization using 5% of data" = "#8ae0e3", "evaluation using full data" = "#65b510", "evaluation using 5% of data" = "#afe6a3", "evaluation using full data (training)" = "#d1b8db","Lasso-algorithm time" = "#e889e2"))+
  facet_grid(rows = vars(dataset_name), cols = vars(actual_n_seq)) +
  labs(fill = "Operation",x="",y="CPU time (seconds)")  +theme(axis.text.x = element_text(angle = 60, vjust = 0.9, hjust=1))

```





Operation analysis 

```{r}
n_cores_full =1
n_cores_lasso = 1

lasso_training<-spr_data_edited %>% select (actual_n_seq, dataset_name,n_op = full_size_training_evaluation_time_phase_0) %>% mutate(operation = "Evaluation",search_type = "Lasso-based search", phase = "training")

lasso_first_phase_no_brlen<-spr_data_edited %>% select (actual_n_seq, dataset_name,n_op =phase_0_total_spr_neighbours_evaluated) %>% mutate(operation = "Evaluation",search_type = "Lasso-based search", phase = "first_phase",n_op = n_op * 0.05)

lasso_first_phase_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op = phase_0_total_spr_neighbours_optimized) %>% mutate(operation = "Branch-lengths optimization" ,search_type = "Lasso-based search",phase = "first_phase",n_op = n_op * 0.05)  

lasso_final_phase_no_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op = final_phase_total_spr_neighbours_evaluated) %>% mutate(operation = "Evaluation",search_type = "Lasso-based search",phase = "final_phase",n_op = n_op * 0.05)

lasso_final_phase_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op = final_phase_total_spr_neighbours_optimized) %>% mutate(operation = "Branch-lengths optimization" ,search_type = "Lasso-based search",phase = "final_phase") 

naive_no_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op =naive_SPR_total_spr_neighbours_evaluated) %>% mutate(operation = "Evaluation" , search_type = "Standard search",phase = "Naive")

naive_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op =naive_SPR_total_spr_neighbours_optimized) %>% mutate(operation = "Branch-lengths optimization", search_type = "Standard search",phase = "Naive") 

running_time_data<-rbind(lasso_first_phase_no_brlen,lasso_first_phase_brlen,lasso_final_phase_no_brlen,lasso_final_phase_brlen,naive_no_brlen,naive_brlen,lasso_training)
overall_running_time_data<-running_time_data %>% group_by(dataset_name, actual_n_seq,operation,search_type) %>% summarise(n_op = sum(n_op))

running_time_data %>% arrange(dataset_name, actual_n_seq,operation,search_type)


overall_running_time_data  %>% ggplot(aes(x=search_type, y=n_op, fill=operation)) +
  geom_bar(stat="identity")+
  scale_fill_manual("legend", values = c("Branch-lengths optimization"= "#3e7db8", "Evaluation" = "#afe6a3"))+
  facet_grid(rows = vars(dataset_name), cols = vars(actual_n_seq)) +
  labs(fill = "Operation",x="",y="Per-site operations counts")  +theme(axis.text.x = element_text(angle = 60, vjust = 0.9, hjust=1))

```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

