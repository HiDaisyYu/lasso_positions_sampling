---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
#"/Users/noa/Workspace/lasso_positions_sampling_results/f_g30.tsv"
options(digits=10)
spr_data<-bind_rows(read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f_mg15.tsv"), read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f2_mg30.tsv")
                    )
                    
#read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f_g30.tsv")
#read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f_g30.tsv")
```

15,30 and 60 taxa analysis

```{r}
spr_data_edited<- spr_data  %>%
            separate(dataset_id, "_supermatrices_",
                into = c("prefix", "last_value"), 
                remove = FALSE) %>% separate(last_value,"_",into = c("dataset_name", "suffix")) %>%  select(-c("prefix","suffix")) %>% select (run_prefix,dataset_name, actual_n_seq, actual_n_loci, `lasso_test_R^2_phase_0`,naive_SPR_SPR_ll,final_phase_SPR_ll, phase_0_SPR_ll,rf_best_naive_vs_best_lasso,                                                                                                               naive_SPR_spr_moves,                                                                                                                  naive_SPR_no_brlen_running_time,
                                                                                                                                               naive_SPR_total_spr_neighbours_evaluated,                                                                                                                    naive_SPR_brlen_running_time,                                                                                                 naive_SPR_total_spr_neighbours_optimized,                                                                                                               naive_SPR_running_time
                                                                                                                                               ,
                                                                                                                                            starting_tree_path,
  naive_SPR_starting_tree_SPR_ll,                                                                                                                       
  phase_0_spr_moves,
  phase_0_re_opt_running_time,
  phase_0_no_brlen_running_time,
  phase_0_total_spr_neighbours_optimized,
  phase_0_total_spr_neighbours_evaluated, phase_0_total_spr_neighbours_reoptimized,
  phase_0_brlen_running_time,
  phase_0_running_time,
  final_phase_spr_moves,
  final_phase_no_brlen_running_time,
  final_phase_total_spr_neighbours_evaluated,
  final_phase_brlen_running_time,
  final_phase_total_spr_neighbours_optimized,
  final_phase_running_time,
  full_training_random_trees_generation_time_phase_0,
  lasso_running_time_phase_0,
   full_size_training_evaluation_time_phase_0
  ) %>% mutate(delta_ll_final = ifelse(rf_best_naive_vs_best_lasso>0,naive_SPR_SPR_ll-final_phase_SPR_ll,0))

spr_data_edited <- spr_data_edited %>% group_by(dataset_name, actual_n_seq, actual_n_loci) %>% mutate (starting_tree_id = row_number()) 
spr_data_edited  %>% select (delta_ll_final,run_prefix,dataset_name, actual_n_seq,naive_SPR_spr_moves,final_phase_spr_moves,naive_SPR_no_brlen_running_time,final_phase_no_brlen_running_time,naive_SPR_total_spr_neighbours_evaluated,final_phase_total_spr_neighbours_evaluated) %>% arrange(dataset_name, actual_n_seq) %>% filter (actual_n_seq>15)

```
Example MSA:
```{r}
n_cores_full =15
n_cores_lasso = 1
example_msa_data<-spr_data_edited %>% filter (dataset_name=="NagyA1",actual_n_seq==30)
example_msa_data %>% select (delta_ll_final,naive_SPR_running_time, phase_0_running_time, final_phase_running_time)
#example_msa_lasso_iterations<- read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f_g30_nagy_lasso_iterations.tsv") %>% mutate(iter= row_number()) 
example_msa_lasso_iterations<- read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/Stru_lasso_iterations.tsv") %>% mutate(iter= row_number()) 
#example_msa_naive_iterations<- read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/f_g30_nagy_full_iterations.tsv") %>% mutate(iter= row_number()) 
example_msa_naive_iterations<- read_tsv("/Users/noa/Workspace/lasso_positions_sampling_results/Stru_naive_iterations.tsv") %>% mutate(iter= row_number()) 
example_msa_lasso_iterations
example_msa_lasso_iterations %>% select (phase_name, ll, true_ll)

best_ll = max(c(example_msa_naive_iterations %>% pull (true_ll),example_msa_lasso_iterations %>% pull (true_ll)))
start_ll = example_msa_naive_iterations %>% pull(true_ll)

example_msa_iterations<-rbind(example_msa_lasso_iterations,example_msa_naive_iterations)

# local_ll
example_msa_iterations %>% ggplot(aes(x= iter-1,y= ll,colour = phase_name)) + geom_point(size=0.5)+ geom_line()+labs(x="Iteration number" ,y = "local log-likelihood")+theme_classic()+guides(col=guide_legend("Search type"))+theme(strip.text.y = element_text(angle = 0))

# Delta_ll
example_msa_iterations %>% ggplot(aes(x= iter-1,y= best_ll-true_ll,colour = phase_name)) + geom_point(size=0.5)+ geom_line()+labs(x="Iteration number" ,y = "Delta log-likelihood")+theme_classic()+guides(col=guide_legend("Search type"))+theme(strip.text.y = element_text(angle = 0))

# running_times_no_brlen
example_msa_iterations %>% ggplot(aes(x= iter-1,y= no_brlen_times,colour = phase_name)) + geom_point(size=0.5)+ geom_line()+labs(x="Iteration number" ,y = "No-brlen running times")+theme_classic()+guides(col=guide_legend("Search type"))+theme(strip.text.y = element_text(angle = 0))

# running_times_=brlen
example_msa_iterations %>% ggplot(aes(x= iter-1,y= brlen_times,colour = phase_name)) + geom_point(size=0.5)+ geom_line()+labs(x="Iteration number" ,y = "brlen running times")+theme_classic()+guides(col=guide_legend("Search type"))+theme(strip.text.y = element_text(angle = 0))


example_msa_iterations %>% ggplot(aes(x= iter-1,y= n_spr_eval,colour = phase_name)) + geom_point(size=0.5)+ geom_line()+labs(x="Iteration number" ,y = "N SPR eval")+theme_classic()+guides(col=guide_legend("Search type"))+theme(strip.text.y = element_text(angle = 0))


 # running_time_analysis
example_msa_data %>% select (naive_SPR_no_brlen_running_time,naive_SPR_brlen_running_time, phase_0_no_brlen_running_time, phase_0_brlen_running_time,final_phase_no_brlen_running_time, final_phase_brlen_running_time, full_size_training_evaluation_time_phase_0, lasso_running_time_phase_0) %>% mutate (run_time_naive = n_cores_full*(naive_SPR_no_brlen_running_time+naive_SPR_brlen_running_time), run_time_lasso = n_cores_lasso*(phase_0_no_brlen_running_time+phase_0_brlen_running_time) + n_cores_lasso*final_phase_no_brlen_running_time+n_cores_full*final_phase_brlen_running_time, run_time_training = full_size_training_evaluation_time_phase_0* n_cores_full, run_time_lasso_algorithm =lasso_running_time_phase_0  ) %>% mutate(ratio_including_training =run_time_naive/(run_time_lasso+run_time_training+run_time_lasso_algorithm
) , ratio_without_training =run_time_naive/run_time_lasso)



# Operations and SPR moves analysis
example_msa_data %>% select (phase_0_spr_moves,naive_SPR_spr_moves,final_phase_spr_moves,naive_SPR_total_spr_neighbours_evaluated,naive_SPR_total_spr_neighbours_optimized, phase_0_total_spr_neighbours_evaluated, phase_0_total_spr_neighbours_optimized,final_phase_total_spr_neighbours_evaluated, final_phase_total_spr_neighbours_optimized, full_size_training_evaluation_time_phase_0) %>% mutate (naive_full_brlen_opt = naive_SPR_total_spr_neighbours_optimized,naive_full_eval =naive_SPR_total_spr_neighbours_evaluated, lasso_sampled_eval =phase_0_total_spr_neighbours_evaluated+final_phase_total_spr_neighbours_evaluated, lasso_sampled_optimized = phase_0_total_spr_neighbours_optimized, lasso_full_optimized = final_phase_total_spr_neighbours_optimized )


```
General running-time analysis 

```{r}
n_cores_full =15
n_cores_lasso = 1
n_starting_trees = 3

 # running_time_analysis
all_msa_running_time<-spr_data_edited %>% select (dataset_name,`lasso_test_R^2_phase_0`,starting_tree_path,delta_ll_final,actual_n_seq,naive_SPR_no_brlen_running_time,naive_SPR_brlen_running_time, phase_0_no_brlen_running_time, phase_0_brlen_running_time,final_phase_no_brlen_running_time, final_phase_brlen_running_time, full_size_training_evaluation_time_phase_0, lasso_running_time_phase_0) %>% mutate (run_time_naive = n_cores_full*(naive_SPR_no_brlen_running_time+naive_SPR_brlen_running_time), run_time_lasso = n_cores_lasso*(phase_0_no_brlen_running_time+phase_0_brlen_running_time) + (n_cores_lasso*final_phase_no_brlen_running_time)+(n_cores_full*final_phase_brlen_running_time), run_time_training = full_size_training_evaluation_time_phase_0* n_cores_full, run_time_lasso_algorithm =lasso_running_time_phase_0  ) %>% mutate(ratio_including_training =run_time_naive/(run_time_lasso+((run_time_training+run_time_lasso_algorithm)/n_starting_trees
)) , ratio_without_training =run_time_naive/run_time_lasso) 

all_msa_running_time %>% select (dataset_name,run_time_naive, actual_n_seq,run_time_lasso, run_time_lasso_algorithm, run_time_training ) %>% arrange(dataset_name, actual_n_seq)
all_msa_running_time %>% group_by(actual_n_seq) %>% summarise(median_ratio_including_training = median (ratio_including_training),median_ratio_without_training = median ( ratio_without_training))

excluding_training_phase<-all_msa_running_time %>% ggplot(aes(x=ratio_without_training, y=delta_ll_final, color = dataset_name,)) + geom_point(size = 3) + facet_grid(cols = vars(actual_n_seq)) + scale_x_continuous(limits = c(0, 30),expand = c(0, 0)) +theme_classic() + theme(axis.text.x = element_text(angle = 60, vjust = 0.9, hjust=1))+
  labs(color = "Empirical MSA",x="Running-time decrease factor\n excluding training phase",y="Delta LL")

including_training_phase<-all_msa_running_time %>% ggplot(aes(x=ratio_including_training,y=delta_ll_final, color = dataset_name)) + geom_point(size =3) + facet_grid(cols = vars(actual_n_seq))  + scale_x_continuous(limits = c(0, 30),expand = c(0, 0)) +theme_classic()+ theme(axis.text.x = element_text(angle = 60, vjust = 0.9, hjust=1))+
  labs(color = "Empirical MSA",x="Running-time decrease factor\n including training phase",y="Delta LL")

ggarrange(excluding_training_phase, including_training_phase, hjust=-1,vjust=1, heights=c(2,2),common.legend=TRUE,
          labels = c("A", "B"),
          ncol = 2, nrow =1)


```



Run time analysis per operation

```{r}
n_starting_trees  = 3

lasso_training<-spr_data_edited %>% distinct (actual_n_seq, dataset_name,time =full_size_training_evaluation_time_phase_0) %>% mutate(operation = "evaluation using full data (training data generation)", time = time *n_cores_full,search_type = "Lasso-based search", phase = "training",starting_tree_id =-1)

lasso_cd<-spr_data_edited %>% distinct (actual_n_seq, dataset_name,time =lasso_running_time_phase_0) %>% mutate(operation = "Lasso-algorithm time", time = time ,search_type = "Lasso-based search", phase = "training",starting_tree_id  =-1) 

lasso_first_phase_no_brlen<-spr_data_edited %>% select (actual_n_seq, dataset_name,time =phase_0_no_brlen_running_time,starting_tree_id ) %>% mutate(operation = "evaluation using 5% of data", time = time *n_cores_lasso,search_type = "Lasso-based search", phase = "first_phase")
lasso_first_phase_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =phase_0_brlen_running_time, starting_tree_id ) %>% mutate(operation = "branch-lengths optimization using 5% of data", time = time*n_cores_lasso ,search_type = "Lasso-based search",phase = "first_phase")  

lasso_final_phase_no_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =final_phase_no_brlen_running_time,starting_tree_id ) %>% mutate(operation = "evaluation using 5% of data",time=time *n_cores_lasso ,search_type = "Lasso-based search",phase = "final_phase") 
lasso_final_phase_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =final_phase_brlen_running_time,starting_tree_id ) %>% mutate(operation = "branch-lengths optimization using full data",time= time *n_cores_full ,search_type = "Lasso-based search",phase = "final_phase") 

naive_no_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =naive_SPR_no_brlen_running_time,starting_tree_id ) %>% mutate(operation = "evaluation using full data",time= time *n_cores_full , search_type = "Standard search",phase = "Naive")

naive_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,time =naive_SPR_brlen_running_time,starting_tree_id ) %>% mutate(operation = "branch-lengths optimization using full data",time= time *n_cores_full , search_type = "Standard search",phase = "Naive") 

running_time_data<-rbind(lasso_first_phase_no_brlen,lasso_first_phase_brlen,lasso_final_phase_no_brlen,lasso_final_phase_brlen,naive_no_brlen,naive_brlen,lasso_training,lasso_cd)



```

Aggregations of running_time_data

```{r}

running_time_data %>% filter(dataset_name=="MisoA2", actual_n_seq==30) %>% select(starting_tree_id,operation,search_type,phase, time)  %>% arrange(starting_tree_id,search_type,phase,operation,time)

running_time_data %>% group_by(dataset_name, actual_n_seq,operation,search_type) %>% summarise(time = sum(time))

running_time_data %>% distinct (dataset_name, actual_n_seq,starting_tree_id,operation,search_type, time) %>% arrange(dataset_name, actual_n_seq) 

running_time_data  %>% group_by(dataset_name, actual_n_seq, search_type) %>% summarise(time = sum(time)) %>% pivot_wider(names_from = search_type, values_from="time") %>% select (lasso ='Lasso-based search', standard = 'Standard search' )  %>%  mutate(ratio = standard/lasso) %>% arrange(actual_n_seq)

```



```{r}
running_time_data %>% group_by(dataset_name, actual_n_seq, search_type) %>% mutate(time = time/sum(time)) %>% ggplot(aes(x=search_type, y=(time), fill=operation)) +
          scale_y_continuous(labels=scales::percent) +
  geom_bar(stat="identity",width = 0.8)+ #position = "dodge"
  scale_fill_manual("Operation", values = c("branch-lengths optimization using full data"= "#3e7db8","branch-lengths optimization using 5% of data" = "#8ae0e3", "evaluation using full data" = "#65b510", "evaluation using 5% of data" = "#afe6a3","Lasso-algorithm time" = "#e889e2","evaluation using full data (training data generation)" = "#de5a5a"))+
  facet_grid(cols = vars(dataset_name), rows = vars(actual_n_seq)) +
theme_classic()+theme(axis.text.x = element_text(angle = 60, vjust = 0.9, hjust=1))+labs(x="",y="CPU time (seconds)") 
```



Operation analysis 

```{r}
n_cores_full =15
n_cores_lasso = 1

lasso_training<-spr_data_edited %>% select (actual_n_seq, dataset_name,n_op = full_size_training_evaluation_time_phase_0) %>% mutate(operation = "Evaluation",search_type = "Lasso-based search", phase = "training")

lasso_first_phase_no_brlen<-spr_data_edited %>% select (actual_n_seq, dataset_name,n_op =phase_0_total_spr_neighbours_evaluated) %>% mutate(operation = "Evaluation",search_type = "Lasso-based search", phase = "first_phase",n_op = n_op * 0.05)

lasso_first_phase_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op = phase_0_total_spr_neighbours_optimized) %>% mutate(operation = "Branch-lengths optimization" ,search_type = "Lasso-based search",phase = "first_phase",n_op = n_op * 0.05)  

lasso_final_phase_no_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op = final_phase_total_spr_neighbours_evaluated) %>% mutate(operation = "Evaluation",search_type = "Lasso-based search",phase = "final_phase",n_op = n_op * 0.05)

lasso_final_phase_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op = final_phase_total_spr_neighbours_optimized) %>% mutate(operation = "Branch-lengths optimization" ,search_type = "Lasso-based search",phase = "final_phase") 

naive_no_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op =naive_SPR_total_spr_neighbours_evaluated) %>% mutate(operation = "Evaluation" , search_type = "Standard search",phase = "Naive")

naive_brlen<- spr_data_edited %>% select (actual_n_seq, dataset_name,n_op =naive_SPR_total_spr_neighbours_optimized) %>% mutate(operation = "Branch-lengths optimization", search_type = "Standard search",phase = "Naive") 

running_time_data<-rbind(lasso_first_phase_no_brlen,lasso_first_phase_brlen,lasso_final_phase_no_brlen,lasso_final_phase_brlen,naive_no_brlen,naive_brlen,lasso_training)
overall_running_time_data<-running_time_data %>% group_by(dataset_name, actual_n_seq,operation,search_type) %>% summarise(n_op = sum(n_op))

running_time_data %>% arrange(dataset_name, actual_n_seq,operation,search_type)


overall_running_time_data  %>% ggplot(aes(x=search_type, y=n_op, fill=operation)) +
  geom_bar(stat="identity")+
  scale_fill_manual("legend", values = c("Branch-lengths optimization"= "#3e7db8", "Evaluation" = "#afe6a3"))+
  facet_grid(cols = vars(dataset_name), rows = vars(actual_n_seq)) +
  labs(fill = "Operation",x="",y="Per-site operations counts")  +theme(axis.text.x = element_text(angle = 60, vjust = 0.9, hjust=1))

```



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

